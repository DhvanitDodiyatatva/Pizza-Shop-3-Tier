@{
    ViewData["Title"] = "Customers";
}

<div class="mt-0 p-xl-5 p-lg-4 p-md-4 p-sm-4 p-4">
    <div class="my-2 z-0">
        <div class="row mb-2 align-items-center">
            <div class="col-12 col-md-3 col-lg-2 mb-2 mb-md-0">
                <div class="fw-bolder fs-2 page-text">Customers</div>
            </div>
            <div class="col-12 col-md-9 col-lg-10">
                <div class="d-flex flex-wrap align-items-center justify-content-end gap-2">
                    <form class="d-flex align-items-center flex-grow-1 flex-md-grow-0" role="search" id="searchForm">
                        <div class="input-group position-relative form-floating w-100" style="max-width: 350px;">
                            <input class="form-control" type="search" placeholder="Search" aria-label="Search"
                                id="Search" name="searchQuery" />
                            <label for="Search">Search</label>
                            <span class="search-img-desktop position-absolute"
                                style="right: 10px; top: 50%; transform: translateY(-50%);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-search" viewBox="0 0 16 16">
                                    <path
                                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
                                </svg>
                            </span>
                        </div>
                    </form>
                    <div class="form-floating" style="max-width: 150px;">
                        <select class="form-select" aria-label="Time filter" id="timeFilter">
                            <option value="" selected>ALL TIME</option>
                            <option value="today">Today</option>
                            <option value="this_week">This Week</option>
                            <option value="this_month">This Month</option>
                            <option value="custom">Custom Date</option>
                        </select>
                        <label>TimeFrame</label>
                    </div>

                    <form id="exportForm" action="@Url.Action("ExportCustomers", "Customer")" method="get">
                        <input type="hidden" name="searchQuery" id="exportSearchQuery" />
                        <input type="hidden" name="timeFilter" id="exportTimeFilter" />
                        <input type="hidden" name="fromDate" id="exportFromDate" />
                        <input type="hidden" name="toDate" id="exportToDate" />
                        <input type="hidden" name="sortColumn" id="exportSortColumn" />
                        <input type="hidden" name="sortDirection" id="exportSortDirection" />
                        <button type="submit" class="btn btn-main text-white py-3" style="padding: 0.375rem 0.75rem;">
                            <img src="~/images/export.png" style="height: 20px; width: 20px;">
                            Export
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="CustomerListContainer">
        <!-- Customer list will be loaded here via AJAX -->
    </div>

    <!-- Modal -->
    <div class="modal fade  " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Select Date Range</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 form-floating flex-grow-1 flex-md-grow-0 mb-3" style="max-width: 350px;">
                            <input type="date" class="form-control" id="fromDate" />
                            <label for="fromDate">From date</label>
                        </div>
                        <div class="col-md-6 form-floating flex-grow-1 flex-md-grow-0 mb-3" style="max-width: 350px;">
                            <input type="date" class="form-control" id="toDate" />
                            <label for="toDate">To date</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-main text-white" id="submitDateRange">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentSearchQuery = '';
    let currentSortColumn = 'Name';
    let currentSortDirection = 'asc';
    let currentPage = 1;
    let currentPageSize = 5;
    let currentTimeFilter = '';
    let currentFromDate = '';
    let currentToDate = '';
    let searchTimeout;

    function loadCustomerList() {
        $.ajax({
            url: '@Url.Action("GetCustomerList", "Customer")',
            type: 'GET',
            data: {
                searchQuery: currentSearchQuery,
                sortColumn: currentSortColumn,
                sortDirection: currentSortDirection,
                page: currentPage,
                pageSize: currentPageSize,
                timeFilter: currentTimeFilter,
                fromDate: currentFromDate,
                toDate: currentToDate
            },
            success: function (data) {
                $('#CustomerListContainer').html(data);
                attachEventListeners();
            },
            error: function () {
                alert('Error loading customer list');
            }
        });
    }

    function attachEventListeners() {
        $('.sort-link').click(function (e) {
            e.preventDefault();
            currentSortColumn = $(this).data('column');
            currentSortDirection = $(this).data('direction');
            currentPage = 1;
            loadCustomerList();
        });

        $('.page-nav').click(function (e) {
            e.preventDefault();
            if (!$(this).parent().hasClass('disabled')) {
                currentPage = $(this).data('page');
                loadCustomerList();
            }
        });

        $('.page-size-link').click(function (e) {
            e.preventDefault();
            currentPageSize = $(this).data('size');
            currentPage = 1;
            loadCustomerList();
        });

        $('.customer-row').click(function () {
            var customerId = $(this).data('customer-id');
            $.ajax({
                url: '@Url.Action("GetCustomerHistory", "Customer")',
                type: 'GET',
                data: { customerId: customerId },
                success: function (data) {
                    $('body').append(data);
                    $('#customerHistoryModal').modal('show');
                    $('#customerHistoryModal').on('hidden.bs.modal', function () {
                        $(this).remove();
                    });
                },
                error: function () {
                    alert('Error loading customer history');
                }
            });
        });
    }


    $('#exportForm').on('submit', function () {
        $('#exportSearchQuery').val(currentSearchQuery);
        $('#exportTimeFilter').val(currentTimeFilter);
        $('#exportFromDate').val(currentFromDate);
        $('#exportToDate').val(currentToDate);
        $('#exportSortColumn').val(currentSortColumn);
        $('#exportSortDirection').val(currentSortDirection);
    });

    $(document).ready(function () {
        //Search 
        $('#Search').on('keyup', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchQuery = $(this).val();
                currentPage = 1;
                loadCustomerList();
            }, 300);
        });

        //Time Filter
        $('#timeFilter').on('change', function () {
            currentTimeFilter = $(this).val();
            currentFromDate = '';
            currentToDate = '';

            if (currentTimeFilter === 'custom') {
                $('#exampleModal').modal('show');
            } else {
                currentPage = 1;
                loadCustomerList();
            }
        });

        //Custom Date Modal
        $('#submitDateRange').on('click', function () {
            currentFromDate = $('#fromDate').val();
            currentToDate = $('#toDate').val();

            if (currentFromDate && currentToDate) {
                currentPage = 1;
                loadCustomerList();
                $('#exampleModal').modal('hide');
            } else {
                alert('Please select both dates');
            }
        });

        loadCustomerList();
    });
</script>