@{
    ViewData["Title"] = "Orders";
}

<div class=" mt-0 p-xl-5 p-lg-4 p-md-4 p-sm-4 p-4">
    <div class="my-2 z-0">
        <div class="row mb-2 align-items-center">
            <div class="col-12 col-md-3 col-lg-2 mb-2 mb-md-0">
                <div class="fw-bolder fs-2 page-text">Orders</div>
            </div>
            <div class="col-12 col-md-9 col-lg-10">
                <div class="d-flex flex-wrap align-items-center justify-content-end gap-2">
                    <form class="d-flex align-items-center flex-grow-1 flex-md-grow-0" role="search" id="searchForm">
                        <div class="input-group position-relative form-floating w-100" style="max-width: 350px;">
                            <input class="form-control" type="search" placeholder="Search" aria-label="Search"
                                id="Search" name="searchQuery" />
                            <label for="Search">Search</label>
                            <span class="search-img-desktop position-absolute"
                                style="right: 10px; top: 50%; transform: translateY(-50%);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-search" viewBox="0 0 16 16">
                                    <path
                                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
                                </svg>
                            </span>
                        </div>
                    </form>
                    <div class="form-floating" style="max-width: 150px;">
                        <select class="form-select" aria-label="Status filter" id="statusFilter">
                            <option selected value="">ALL STATUS</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="on_hold">On Hold</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="served">Served</option>
                        </select>
                        <label>Status</label>
                    </div>
                    <div class="form-floating" style="max-width: 150px;">
                        <select class="form-select" aria-label="Time filter" id="timeFilter">
                            <option selected value="">ALL TIME</option>
                            <option value="today">Today</option>
                            <option value="this_week">This Week</option>
                            <option value="this_month">This Month</option>
                        </select>
                        <label>Timeframe</label>
                    </div>
                    <form id="exportForm" action="@Url.Action("ExportOrders", "Orders")" method="get">
                        <input type="hidden" name="searchQuery" id="exportSearchQuery" />
                        <input type="hidden" name="statusFilter" id="exportStatusFilter" />
                        <input type="hidden" name="timeFilter" id="exportTimeFilter" />
                        <input type="hidden" name="fromDate" id="exportFromDate" />
                        <input type="hidden" name="toDate" id="exportToDate" />
                        <input type="hidden" name="sortColumn" id="exportSortColumn" />
                        <input type="hidden" name="sortDirection" id="exportSortDirection" />
                        <button type="submit" class="btn btn-main text-white py-3" style="padding: 0.375rem 0.75rem;">
                            <img src="~/images/export.png" style="height: 20px; width: 20px;">
                            Export
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap justify-content-end gap-2 position-relative z-0">
            <div class="form-floating flex-grow-1 flex-md-grow-0" style="max-width: 350px;">
                <input type="date" class="form-control" id="fromDate" />
                <label for="fromDate">From date</label>
            </div>
            <div class="form-floating flex-grow-1 flex-md-grow-0" style="max-width: 350px;">
                <input type="date" class="form-control" id="toDate" />
                <label for="toDate">To date</label>
            </div>
            <button class="btn btn-main text-white" style="padding: 0.375rem 0.75rem;" id="searchButton">Search</button>
            <button class="btn btn-main text-white" style="padding: 0.375rem 0.75rem;" id="clearButton">Clear</button>
        </div>
    </div>
    <div id="orderListContainer">
        <!-- Order list will be loaded here via AJAX -->
    </div>
</div>

@section Scripts {

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        $(document).ready(function () {
            loadOrders();

            // Handle search form submission
            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                loadOrders();
            });

            // Handle search button click
            $('#searchButton').on('click', function (e) {
                e.preventDefault();
                loadOrders();
            });

            // Handle clear button click
            $('#clearButton').on('click', function (e) {
                e.preventDefault();
                $('#Search').val('');
                $('#statusFilter').val('');
                $('#timeFilter').val('');
                $('#fromDate').val('');
                $('#toDate').val('');
                loadOrders();
            });

            // Handle filter changes
            $('#statusFilter, #timeFilter, #fromDate, #toDate').on('change', function () {
                loadOrders();
            });

            // Handle sorting and pagination clicks pageDropdown
            $(document).on('click', '.sort-link, .page-link, .pageDropdown', function (e) {
                @* debugger; *@
                    e.preventDefault();
                var url = $(this).attr('href');
                if (url) {
                    loadOrders(url);
                }
            });

            // Handle export form submission
            $('#exportForm').on('submit', function (e) {
                // Populate hidden fields with current filter values
                $('#exportSearchQuery').val($('#Search').val());
                $('#exportStatusFilter').val($('#statusFilter').val());
                $('#exportTimeFilter').val($('#timeFilter').val());
                $('#exportFromDate').val($('#fromDate').val());
                $('#exportToDate').val($('#toDate').val());
                $('#exportSortColumn').val(getParameterByName('sortColumn', window.location.href) || '');
                $('#exportSortDirection').val(getParameterByName('sortDirection', window.location.href) || '');
            });

            // Handle PDF invoice generation
            $(document).on("click", "#pdfInvoice", function () {
                var orderId = $(this).data("orderid");
                console.log("Clicked", orderId);

                $.ajax({
                    url: "/Orders/Invoice",
                    type: "GET",
                    data: { orderId: orderId },
                    success: function (response) {
                        console.log("Successfully fetched invoice");

                        // Create a hidden iframe
                        var iframe = $("<iframe>").css({
                            "width": "1000px",
                            "height": "1000px",
                            "position": "fixed",
                            "top": "-9999px",
                            "left": "-9999px",
                            "z-index": "-1"
                        }).appendTo("body");

                        var iframeDoc = iframe[0].contentDocument || iframe[0].contentWindow.document;
                        iframeDoc.open();
                        iframeDoc.write(response);
                        iframeDoc.close();

                        setTimeout(function () {
                            html2canvas(iframeDoc.body, { scale: 2, useCORS: true }).then(function (canvas) {
                                var imgData = canvas.toDataURL("image/png");
                                var { jsPDF } = window.jspdf;
                                var pdf = new jsPDF("p", "mm", "a4");
                                var imgWidth = 210;
                                var imgHeight = (canvas.height * imgWidth) / canvas.width;
                                pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
                                pdf.save("invoice_" + orderId + ".pdf");
                                iframe.remove();
                            }).catch(function (error) {
                                console.error("Error rendering canvas:", error);
                                toastr.error("Error generating PDF. Please try again.");
                                iframe.remove();
                            });
                        }, 1000);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching invoice:", error);
                        toastr.error("Error fetching invoice. Please try again.");
                    }
                });
            });

        });




        function loadOrders(url) {
            @* debugger; *@
                                        var searchQuery = $('#Search').val();
            var statusFilter = $('#statusFilter').val();
            var timeFilter = $('#timeFilter').val();
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            var baseUrl = url || '@Url.Action("GetOrderList", "Orders")';

            $.ajax({
                url: baseUrl,
                type: 'GET',
                data: {
                    searchQuery: searchQuery,
                    statusFilter: statusFilter,
                    timeFilter: timeFilter,
                    fromDate: fromDate,
                    toDate: toDate,
                    sortColumn: getParameterByName('sortColumn', baseUrl) || '',
                    sortDirection: getParameterByName('sortDirection', baseUrl) || '',
                    page: getParameterByName('page', baseUrl) || 1,
                    pageSize: getParameterByName('pageSize', baseUrl) || 5
                },
                success: function (data) {
                    $('#orderListContainer').html(data);
                },
                error: function () {
                    alert('Error loading orders');
                }
            });
        }

        function getParameterByName(name, url) {
            if (!url) {
                url = window.location.href;
            }
            // Add a question mark to the name to match it in the URL (e.g., "?page=" or "&page=")
            var nameToFind = name + "=";

            // Find the part of the URL after the "?"
            var queryString = url.split("?")[1];

            if (!queryString) {
                return null;
            }
            // Split the query string into individual parameters (e.g., "page=1&sort=asc" becomes ["page=1", "sort=asc"])
            var params = queryString.split("&");
            // Loop through each parameter to find the one we want
            for (var i = 0; i < params.length; i++) {
                var param = params[i];
                if (param.indexOf(nameToFind) === 0) {
                    var value = param.split("=")[1];
                    if (!value) {
                        return "";
                    }
                    return decodeURIComponent(value.replace(/\+/g, " "));
                }
            }


            return null;
        }
    </script>
}