@{
    ViewData["Title"] = "Table And Section";
}

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>


<div class="Users-content mt-0 p-xl-5 p-lg-4 p-md-4 p-sm-4 p-4">


    <div class="d-flex align-items-center justify-content-between my-2">
        <div>
            <div class="fw-bolder fs-2 page-text">Sections/Tables</div>
        </div>
        <div class="d-flex">
            <a asp-controller="TableAndSection" asp-action="Index"><button
                    class="btn btn-main bg-primary rounded-2 ms-1 text-white fs-6 d-none d-lg-block"
                    type="submit">Back</button></a>
            <a asp-controller="TableAndSection" asp-action="Index"><button
                    class="btn btn-main bg-primary rounded- ms-1 text-white fs-6 d-block d-lg-none" type="submit">
                    < </button></a>
        </div>
    </div>

    <div class="row bg-white shadow-lg rounded-2">
        <div id="category-section" class="col-xl-3 col-lg-4 col-md-12 col-12 ps-3 pe-0 category-section"
            style="background: rgba(215,237,255,1);">
            <div class="row d-flex py-3 pe-3">
                <div class="d-flex align-items-center fw-bold justify-content-between page-text fs-5">
                    Sections
                    @if (User.HasClaim(c => c.Type == "Permission_TableAndSection" && (c.Value == "Alter")))
                    {
                        <button type="button" class="btn bg-white btn-outline-dark text-black" data-bs-toggle="modal"
                            data-bs-target="#exampleModal12" data-bs-whatever="">
                            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor"
                                class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2" />
                            </svg>
                        </button>
                    }
                </div>
            </div>
            <div style="overflow: auto; height: 50dvh;" class="custom-scrollbar" id="sectionsContainer">
                <!-- Sections loaded here via AJAX -->
            </div>
        </div>
        <!-- Content Section -->
        <div id="content-section" class="col-xl-9 col-lg-8 col-md-12 col-12 p-2">
            <div class="row menu-content">
                <div class="col d-flex align-items-center" id="toggle-container">
                    <div>
                        <svg id="categoryToggle" xmlns="http://www.w3.org/2000/svg" width="30" height="30"
                            fill="currentColor" class="bi bi-list-ul me-2" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2" />
                        </svg>
                    </div>
                    <div class="fw-bolder fs-5 page-text">Tables</div>
                </div>
            </div>
            <div class="row">
                <div class="d-flex justify-content-end">
                    <form class="d-flex align-items-center me-2 rounded-end-3" role="search" id="searchForm">
                        <div class="input-group position-relative">
                            <input class="form-control" type="search" placeholder="Search" aria-label="Search"
                                id="searchInput" />
                            <span class="search-img-desktop position-absolute">
                                <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor"
                                    class="bi bi-search" viewBox="0 0 16 16">
                                    <path
                                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
                                </svg>
                            </span>
                        </div>
                    </form>
                    <div>
                        @if (User.HasClaim(c => c.Type == "Permission_TableAndSection" && (c.Value == "Delete")))
                        {
                            <button class="btn btn-outline-secondary rounded-2 fs-6" id="deleteSelected" type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                    class="bi bi-trash3-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5" />
                                </svg>
                            </button>
                        }
                    </div>

                    <div>
                        @if (User.HasClaim(c => c.Type == "Permission_TableAndSection" && (c.Value == "Alter")))
                        {
                            <button type="button" class="btn btn-main btn-main text-white d-none d-lg-block ms-2"
                                id="addNewItemBtn">+ New Table</button>
                            <button class="btn btn-main bg-primary rounded-2 ms-2 text-white fs-6 d-block d-lg-none"
                                id="addNewItemBtnMobile">+</button>
                        }
                    </div>
                </div>
            </div>
            <div class="content-div table-responsive">
                <table class="table table-hover" id="itemTable">
                    <thead>
                        <tr>
                            <th scope="col">
                                <div class="form-check item-checkbox">
                                    <input class="form-check-input" type="checkbox" value="" id="selectAll">
                                    <label class="form-check-label" for="selectAll">
                                    </label>
                                </div>
                            </th>
                            <th scope="col">Name</th>
                            <th scope="col" class="text-center text-nowrap">Capacity</th>
                            <th scope="col" class="text-center text-nowrap">Status</th>
                            <th scope="col" class="text-center text-nowrap">Action</th>
                        </tr>
                    </thead>
                    <tbody id="GetTableList">
                        <!-- Tables loaded here via AJAX -->
                    </tbody>
                </table>
                <nav>
                    <div class=" d-flex justify-content-end align-items-center ">
                        <div class="pe-2">
                            <label for="pageSizeSelect">Items per page:</label>
                            <select id="pageSizeSelect" class="form-select d-inline-block w-auto">
                                <option value="2">2</option>
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div id="paginationControls" class="d-flex align-items-center">
                            <!-- Pagination controls will be dynamically added here -->
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <div class="category-backdrop"></div>
    </div>

</div>

<div id="AddSection">
    @* _AddSection partial View *@
</div>
<div id="addTableContainer">
    <!--  Add New Item Partial view will load here -->
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {

        let currentPage = 1;
        let pageSize = 5;
        let currentSectionId = 0; // Initialize to 0, will be set after loading sections
        let allTableIds = []; // Store all table IDs for the current section
        let selectedTableIds = []; // Track selected table IDs

        // Function to load tables with pagination
        function loadTables(sectionId, page = 1, size = pageSize) {
            if (!sectionId) {
                $("#GetTableList").html("<tr><td colspan='5'>Please select a section.</td></tr>");
                allTableIds = [];
                selectedTableIds = [];
                updatePaginationControls();
                return;
            }

            $.ajax({
                url: '@Url.Action("GetTables", "TableAndSection")',
                type: 'GET',
                data: { sectionId: sectionId, page: page, pageSize: size },
                success: function (result) {
                    $("#GetTableList").html(result);
                    currentPage = page;
                    currentSectionId = sectionId;

                    // Fetch all table IDs for the current section
                    $.ajax({
                        url: '@Url.Action("GetTables", "TableAndSection")',
                        type: 'GET',
                        data: { sectionId: sectionId, page: 1, pageSize: 9999 },
                        success: function (allTablesResult) {
                            const tempDiv = $('<div>').html(allTablesResult);
                            allTableIds = tempDiv.find('.itemCheckbox').map(function () {
                                return $(this).val();
                            }).get();
                            updateSelectAllState();
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching all table IDs:", error);
                            allTableIds = [];
                            updateSelectAllState();
                        }
                    });

                    updatePaginationControls();
                },
                error: function (xhr, status, error) {
                    console.error("Error loading tables:", error);
                    $("#GetTableList").html("<tr><td colspan='5'>Failed to load tables.</td></tr>");
                    allTableIds = [];
                    updatePaginationControls();
                }
            });
        }

        // Function to update pagination controls
        function updatePaginationControls() {
            const totalPages = parseInt($("#GetTableList").find("input[name='TotalPages']").val()) || 1;
            const currentPage = parseInt($("#GetTableList").find("input[name='CurrentPage']").val()) || 1;
            let paginationHtml = '';

            if (totalPages > 1) {
                paginationHtml += '<nav aria-label="Page navigation">';
                paginationHtml += '<ul class="pagination mb-0">';

                // Previous button
                paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link text-secondary" href="#" data-page="${currentPage - 1}"> < </a>
                </li>`;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link text-secondary" href="#" data-page="${i}">${i}</a>
                    </li>`;
                }

                // Next button
                paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link text-secondary" href="#" data-page="${currentPage + 1}"> > </a>
                </li>`;

                paginationHtml += '</ul></nav>';
            }

            $("#paginationControls").html(paginationHtml);

            // Attach click handlers to pagination links
            $("#paginationControls .page-link").off("click").on("click", function (e) {
                e.preventDefault();
                const page = $(this).data("page");
                if (page && page > 0 && page <= totalPages) {
                    loadTables(currentSectionId, page, pageSize);
                }
            });
        }

        // Function to update the select all checkbox state
        function updateSelectAllState() {
            const selectAllCheckbox = $("#selectAll");
            if (allTableIds.length === 0) {
                selectAllCheckbox.prop("checked", false);
                selectAllCheckbox.prop("indeterminate", false);
                return;
            }

            const selectedInSection = allTableIds.filter(id => selectedTableIds.includes(id)).length;
            if (selectedInSection === allTableIds.length) {
                selectAllCheckbox.prop("checked", true);
                selectAllCheckbox.prop("indeterminate", false);
            } else if (selectedInSection > 0) {
                selectAllCheckbox.prop("checked", true);
                selectAllCheckbox.prop("indeterminate", true);
            } else {
                selectAllCheckbox.prop("checked", false);
                selectAllCheckbox.prop("indeterminate", false);
            }
        }

        // Function to load sections and select the first one
        function loadSections() {
            $.ajax({
                url: '@Url.Action("GetSections", "TableAndSection")',
                type: 'GET',
                success: function (result) {
                    $("#sectionsContainer").html(result);
                    if ($(".section-link").length > 0) {
                        // Select the first section and load its tables
                        const firstSection = $(".section-link").first();
                        const sectionId = firstSection.data("sections-id");
                        firstSection.addClass('active');
                        currentSectionId = sectionId;
                        loadTables(sectionId, 1, pageSize);
                    } else {
                        $("#GetTableList").html("<tr><td colspan='5'>No sections available.</td></tr>");
                    }

                    // Attach click handlers for section links
                    $(".section-link").off("click").on("click", function (e) {
                        e.preventDefault();
                        $("#sectionsContainer .section-link").removeClass('active');
                        $(this).addClass('active');
                        const sectionId = $(this).data("sections-id");
                        selectedTableIds = []; // Reset selection when changing sections
                        loadTables(sectionId, 1, pageSize);
                    });

                    attachEditSectionHandler();
                },
                error: function (xhr, status, error) {
                    console.error("Error loading sections:", error);
                    $("#sectionsContainer").html("<div>Error loading sections.</div>");
                    $("#GetTableList").html("<tr><td colspan='5'>No sections available.</td></tr>");
                }
            });
        }

        // Search functionality with pagination
        $("#searchInput").on("keyup", function () {
            const searchTerm = $(this).val().trim();
            $.ajax({
                url: '@Url.Action("SearchTables", "TableAndSection")',
                type: 'GET',
                data: { searchTerm: searchTerm, sectionId: currentSectionId, page: 1, pageSize: pageSize },
                success: function (response) {
                    $("#GetTableList").html(response);
                    updatePaginationControls();
                },
                error: function () {
                    toastr.error("Failed to search tables.");
                }
            });
        });

        // Page size change handler
        $("#pageSizeSelect").on("change", function () {
            pageSize = parseInt($(this).val());
            loadTables(currentSectionId, 1, pageSize);
        });

        // Function to load the Add Section partial view and attach its form handler
        function loadAddSection() {
            $.ajax({
                url: '@Url.Action("AddNewSection", "TableAndSection")',
                type: 'GET',
                success: function (result) {
                    $("#AddSection").html(result);
                    attachAddSectionFormHandler();
                    $.validator.unobtrusive.parse("#addSectionForm");
                },
                error: function (xhr, status, error) {
                    console.error("Error loading Add Section form:", error);
                }
            });
        }

        // Attach submit handler to the Add Section form
        function attachAddSectionFormHandler() {
            $("#addSectionForm").off("submit").on("submit", function (e) {
                e.preventDefault();
                if (!$(this).valid()) {
                    return;
                }
                const formData = $(this).serialize();
                $.ajax({
                    url: '@Url.Action("AddNewSection", "TableAndSection")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            $(".modal").hide();
                            $('.modal-backdrop').remove();
                            toastr.success("Section added successfully!");
                            loadSections();
                            loadAddSection();
                        } else {
                            toastr.error("Failed to add section: " + response.message);
                            var modalEl = document.getElementById('exampleModal12');
                            if (modalEl) {
                                var modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modal.show();
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error adding section:", error);
                        toastr.error("Error adding section. Please try again.");
                        var modalEl = document.getElementById('exampleModal12');
                        if (modalEl) {
                            var modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                            modal.show();
                        }
                    }
                });
            });
        }

        // Attach edit section button handler
        function attachEditSectionHandler() {
            $(".edit-category-btn").off('click').on("click", function (e) {
                e.preventDefault();
                const sectionId = $(this).data("sections-id");
                $("#editModalView").html("");
                $.ajax({
                    url: '@Url.Action("EditSection", "TableAndSection")',
                    type: 'GET',
                    data: { id: sectionId },
                    cache: false,
                    success: function (data) {
                        $("#editModalView").html(data);
                        const modalElement = document.getElementById('editModal');
                        if (modalElement) {
                            const editModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                            editModal.show();
                            attachEditFormHandler();
                        } else {
                            console.error("Modal element #editModal not found in DOM");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading edit partial view for ID " + sectionId + ":", error);
                        toastr.error("Failed to load edit section form.");
                    }
                });
            });
        }

        // Attach edit form submission handler
        function attachEditFormHandler() {
            $("#editSectionForm").off('submit').on("submit", function (e) {
                e.preventDefault();
                if (!$(this).valid()) {
                    return;
                }
                const formData = $(this).serialize();
                $.ajax({
                    url: '@Url.Action("UpdateSection", "TableAndSection")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            const modalElement = document.getElementById('editModal');
                            const editModal = bootstrap.Modal.getInstance(modalElement);
                            if (editModal) {
                                editModal.hide();
                            }
                            toastr.success(response.message);
                            loadSections();
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error updating section:", error);
                        toastr.error("Error updating section. Please try again.");
                    }
                });
            });
        }

        // Ensure modal backdrop is removed when any modal is hidden
        $('.modal').on('hidden.bs.modal', function () {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
        });

        // Add new table button handler
        $("#addNewItemBtn, #addNewItemBtnMobile").on("click", function () {
            $.ajax({
                url: '@Url.Action("AddNewTable", "TableAndSection")',
                type: 'GET',
                success: function (result) {
                    $("#addTableContainer").html(result);
                    const modal = new bootstrap.Modal(document.getElementById("exampleModal2"));
                    modal.show();
                },
                error: function () {
                    toastr.error("Failed to load add table form.");
                }
            });
        });

        // Delete section handler
        $(document).on('submit', '.delete-category-form', function (e) {
            e.preventDefault();
            const form = $(this);
            const sectionId = form.data('section-id');
            $.ajax({
                url: '@Url.Action("Delete", "TableAndSection")',
                type: 'POST',
                data: form.serialize(),
                success: function (response) {
                    if (response.success) {
                        const modalEl = document.getElementById('deletemodal-' + sectionId);
                        if (modalEl) {
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) {
                                modal.hide();
                            }
                        }
                        $('.modal-backdrop').remove();
                        toastr.success("Section deleted successfully!");
                        loadSections();
                    } else {
                        toastr.error("Error: " + response.message);
                    }
                },
                error: function () {
                    toastr.error("Failed to delete section. Please try again.");
                }
            });
        });

        // Select all checkbox handler
        $("#selectAll").on("click", function () {
            const isChecked = $(this).is(":checked");
            if (isChecked) {
                // Select all tables in the section
                selectedTableIds = [...new Set([...selectedTableIds, ...allTableIds])];
            } else {
                // Deselect all tables in the section
                selectedTableIds = selectedTableIds.filter(id => !allTableIds.includes(id));
            }
            // Update visible checkboxes
            $(".itemCheckbox").prop("checked", isChecked);
            updateSelectAllState();
        });

        // Handle individual checkbox changes
        $(document).on('change', '.itemCheckbox', function () {
            const tableId = $(this).val();
            if ($(this).is(':checked')) {
                if (!selectedTableIds.includes(tableId)) {
                    selectedTableIds.push(tableId);
                }
            } else {
                selectedTableIds = selectedTableIds.filter(id => id !== tableId);
            }
            updateSelectAllState();
        });

        // Ensure checkboxes reflect selection state when loading new pages
        $(document).on('DOMNodeInserted', '#GetTableList', function () {
            $('.itemCheckbox').each(function () {
                const tableId = $(this).val();
                $(this).prop('checked', selectedTableIds.includes(tableId));
            });
        });

        // Delete selected tables handler
        $("#deleteSelected").on("click", function () {
            if (selectedTableIds.length === 0) {
                toastr.warning("Please select at least one table to delete.");
                return;
            }

            if (!confirm("Are you sure you want to delete the selected tables?")) {
                return;
            }

            $.ajax({
                url: '@Url.Action("DeleteTables", "TableAndSection")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(selectedTableIds),
                success: function (response) {
                    if (response.success) {
                        response.deletedIds.forEach(id => {
                            $("tr[data-id='" + id + "']").remove();
                            selectedTableIds = selectedTableIds.filter(tableId => tableId !== id);
                        });
                        toastr.success(response.message);
                        loadTables(currentSectionId, currentPage, pageSize);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function () {
                    toastr.error("An error occurred while deleting tables.");
                }
            });
        });

        // Initialize by loading sections
        loadSections();
        loadAddSection();
    });
</script>

<script>
    document.getElementById("categoryToggle").addEventListener("click", function () {
        var categorySection = document.getElementById("category-section");
        var contentSection = document.getElementById("content-section");
        var toggleContainer = document.getElementById("toggle-container");

        if (window.innerWidth <= 991) {
            categorySection.classList.toggle("category-visible");
            toggleContainer.classList.toggle("toggle-move");
        } else {
            if (categorySection.style.display === "none" || categorySection.classList.contains("d-none")) {
                categorySection.style.display = "block";
                categorySection.classList.remove("d-none");
                if (categorySection.classList.contains("col-xl-3")) {
                    contentSection.classList.remove("col-12");
                    contentSection.classList.add("col-xl-9", "col-lg-8");
                } else if (categorySection.classList.contains("col-xl-4")) {
                    contentSection.classList.remove("col-12");
                    contentSection.classList.add("col-xl-8", "col-lg-8");
                }
            } else {
                categorySection.style.display = "none";
                categorySection.classList.add("d-none");
                contentSection.classList.remove("col-xl-9", "col-lg-8", "col-xl-8");
                contentSection.classList.add("col-12");
            }
        }
    });
</script>

<style>
    .section-link.active {
        color: rgb(63, 137, 216);
        font-size: 1.2rem;
        font-weight: 700;
    }

    .category-option {
        padding: 10px;
        cursor: pointer;
    }
</style>