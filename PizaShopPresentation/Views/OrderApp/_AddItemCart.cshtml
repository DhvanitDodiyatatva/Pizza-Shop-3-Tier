@model PizzaShopRepository.Models.Order
@using Newtonsoft.Json

<div class="card mt-5 mx-5 border-0 shadow-sm" style="border-radius: 15px;">
    <div class="card-body p-3">
        <!-- Table Info -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-muted">
                <img src="~/images/dashboard/tableandSection.png" class="ps-1 pe-2"
                    style="height: 40px; width:40px; background-color: #6eb7eb;">
                <span class="fw-bold" >
                    @Model.OrderTables.FirstOrDefault()?.Table.Section.Name
                    <span  class="me-2">
                        Table: @string.Join(", ", Model.OrderTables.Select(ot => ot.Table.Name))
                    </span>
                </span>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline text-primary-emphasis me-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                        class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                        <path
                            d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z" />
                        <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z" />
                        <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z" />
                        <path
                            d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z" />
                        <path d="M12 9h2V8h-2z" />
                    </svg>
                </button>
                <button class="btn btn-outline text-primary-emphasis me-1" id="customerDetailsButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                        class="bi bi-person-lines-fill" viewBox="0 0 16 16">
                        <path
                            d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1z" />
                    </svg>
                </button>
                <button class="btn btn-outline text-primary-emphasis" id="orderCommentButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                        class="bi bi-chat-left-text" viewBox="0 0 16 16">
                        <path
                            d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z" />
                        <path
                            d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Headers for Item, Quantity, Amount -->
        <div class="d-flex align-items-center mb-1 row">
            <div class="col-6 fw-bold text-start" style="text-align: center;">Item</div>
            <div class="col-3 fw-bold text-end" style="width: 100px; text-align: center;">Quantity</div>
            <div class="col-2 fw-bold text-end" style="width: 100px; text-align: center;">Amount</div>
        </div>

        <!-- Accordion for Items -->
        <div class="accordion mb-2 custom-scrollbar" id="cartAccordion"
            style="max-height: 260px; min-height: 250px; overflow-y: auto; overflow-x: hidden;">
        </div>

        <!-- Subtotal and Taxes -->
        @{
            // Calculate SUBTOTAL: Sum of item base prices and modifier prices
            decimal subtotal = Model.OrderItems.Sum(oi => oi.TotalPrice + oi.OrderItemModifiers.Sum(m => m.Price));
            // Initialize total taxes
            decimal totalTaxes = 0m;
            // Track flat tax checkbox states based on IsApplied
            var flatTaxStates = Model.OrderTaxes
                .Where(t => t.TaxFlat.HasValue)
                .ToDictionary(t => t.Tax.Name, t => t.IsApplied);
            // Calculate taxes
            foreach (var tax in Model.OrderTaxes)
            {
                if (tax.TaxFlat.HasValue && flatTaxStates[tax.Tax.Name])
                {
                    totalTaxes += tax.TaxFlat.Value;
                }
                else if (tax.TaxPercentage.HasValue)
                {
                    totalTaxes += subtotal * (tax.TaxPercentage.Value / 100m);
                }
            }
            const decimal sgstPercentage = 0.0m;
            bool isSgstChecked = true; // Default checked for demo; adjust based on actual logic
            decimal sgstAmount = isSgstChecked ? subtotal * (sgstPercentage / 100m) : 0m;
            totalTaxes += sgstAmount;
            // Calculate TOTAL
            decimal total = subtotal + totalTaxes;
        }
        <div class="mb-3" id="cartSummary">
            <div class="d-flex justify-content-between">
                <span>SUBTOTAL</span>
                <span>₹@subtotal.ToString("F2")</span>
            </div>
            @foreach (var tax in Model.OrderTaxes)
            {
                <div class="d-flex justify-content-between tax-row" data-tax-name="@tax.Tax.Name"
                    style="@(tax.TaxFlat.HasValue && !flatTaxStates[tax.Tax.Name] ? "display: none;" : "")">
                    <span>
                        @if (tax.TaxFlat.HasValue)
                        {
                            <input type="checkbox" class="checkbox flat-tax-checkbox form-check-input" data-tax-name="@tax.Tax.Name"
                                @(flatTaxStates[tax.Tax.Name] ? "checked" : "")>
                        }
                        @tax.Tax.Name
                        @if (tax.TaxFlat.HasValue)
                        {
                            <span>(₹@tax.TaxFlat.Value.ToString("F2"))</span>
                        }
                        else
                        {
                            <span>(@tax.TaxPercentage.Value%)</span>
                        }
                    </span>
                    <span style="display: @(tax.TaxFlat.HasValue ? (flatTaxStates[tax.Tax.Name] ? "block" : "none") : "block");">
                        @if (tax.TaxFlat.HasValue)
                        {
                            <span>₹@tax.TaxFlat.Value.ToString("F2")</span>
                        }
                        else
                        {
                            decimal percentageAmount = subtotal * (tax.TaxPercentage.Value / 100m);
                            <span>₹@percentageAmount.ToString("F2")</span>
                        }
                    </span>
                </div>
            }
            <div class="d-flex justify-content-between fw-bold">
                <span>TOTAL</span>
                <span>₹@total.ToString("F2")</span>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="mb-3 d-flex justify-content-between">
            <div><label class="form-label">Payment Method</label></div>
            <div class="d-flex">
                <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="cash" checked>
                    <label class="form-check-label" for="cash">Cash</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" disabled>
                    <label class="form-check-label" for="card">Card</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="upi" disabled>
                    <label class="form-check-label" for="upi">UPI</label>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
            <button class="btn btn-main text-white" id="saveOrderButton">Save</button>
            <button class="btn btn-outline text-primary-emphasis" id="completeOrderButton">Complete</button>
            <button class="btn btn-outline text-primary-emphasis" id="generateInvoiceButton">Generate Invoice</button>
            <button class="btn btn-outline text-primary-emphasis" id="cancelOrderButton">Cancel</button>
        </div>

        <!-- Complete Confirmation Modal -->
        <div class="modal fade" id="completeConfirmationModal" tabindex="-1" aria-labelledby="completeConfirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="completeConfirmationModalLabel">Confirm Order Completion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex align-items-center justify-content-center flex-column">
                         <img src="~/images/toppng.com-warning-icon-2400x2400.png" alt="DeleteModal"
                                style="height: 80px; width: 80px">
                        Are you sure you want to complete this order?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button type="button" class="btn btn-main text-white" id="confirmCompleteButton">Yes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel Confirmation Modal -->
        <div class="modal fade" id="cancelConfirmationModal" tabindex="-1" aria-labelledby="cancelConfirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelConfirmationModalLabel">Confirm Order Cancellation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex align-items-center justify-content-center flex-column">
                        <img src="~/images/toppng.com-warning-icon-2400x2400.png" alt="CancelModal"
                             style="height: 80px; width: 80px">
                        Are you sure you want to cancel this order?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button type="button" class="btn btn-main text-white" id="confirmCancelButton">Yes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Review Modal -->
        <div class="modal fade" id="customerReviewModal" tabindex="-1" aria-labelledby="customerReviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customerReviewModalLabel">We Value Your Feedback</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-1 d-flex justify-content-between">
                            <label class="form-label">Food Quality</label>
                            <div class="star-rating" data-rating-type="food">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                        </div>
                        <div class="mb-1 d-flex justify-content-between">
                            <label class="form-label">Service</label>
                            <div class="star-rating" data-rating-type="service">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                        </div>
                        <div class="mb-1 d-flex justify-content-between">
                            <label class="form-label">Ambience</label>
                            <div class="star-rating" data-rating-type="ambience">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewComment" class="form-label">Comments</label>
                            <textarea class="form-control" id="reviewComment" rows="3" placeholder="Share your thoughts..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Skip</button>
                        <button type="button" class="btn btn-main text-white" id="submitReviewButton">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Special Instructions Modal -->
        <div class="modal fade" id="specialInstructionsModal" tabindex="-1" aria-labelledby="specialInstructionsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="specialInstructionsModalLabel">Special Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="specialInstructionsInput" class="form-label">Add special instructions for <span id="itemName"></span></label>
                            <textarea class="form-control" id="specialInstructionsInput" rows="3" placeholder="Enter any special instructions..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-main text-white" id="saveSpecialInstructionsButton">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order-Wise Comment Modal -->
        <div class="modal fade" id="orderWiseCommentModal" tabindex="-1" aria-labelledby="orderWiseCommentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderWiseCommentModalLabel">Order Wise Comment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="orderWiseCommentInput" class="form-label">Comment</label>
                            <textarea class="form-control" id="orderWiseCommentInput" rows="3" placeholder="Enter your comment..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-main text-white" id="saveOrderWiseCommentButton">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .star-rating {
        font-size: 24px;
        color: #ddd;
        cursor: pointer;
    }
    .star-rating .star {
        margin-right: 5px;
    }
    .star-rating .star.filled {
        color: #f5c518;
    }
    .item-name-order-card {
        cursor: pointer;
    }
    .item-name-order-card:hover {
        text-decoration: underline;
    }
</style>

<!-- Include jsPDF and html2canvas scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    // Initialize cart with ReadyQuantity and SpecialInstructions
    window.cartItems = window.cartItems || @Html.Raw(JsonConvert.SerializeObject(Model.OrderItems.Select(oi => new
    {
        Id = oi.ItemId,
        OrderItemId = oi.Id,
        Name = oi.Item.Name,
        Quantity = oi.Quantity,
        ItemPrice = oi.UnitPrice,
        TotalPrice = oi.TotalPrice,
        ReadyQuantity = oi.ReadyQuantity,
        SpecialInstructions = oi.SpecialInstructions,
        Modifiers = oi.OrderItemModifiers.Select(oim => new
        {
            Id = oim.ModifierId,
            Name = oim.Modifier.Name,
            Price = oim.Price
        }).ToList(),
        GlobalId = oi.Item.Name.ToLower().Replace(" ", "") + "-" + oi.Id
    })));

    window.orderTaxes = @Html.Raw(JsonConvert.SerializeObject(Model.OrderTaxes.Select(ot => new
    {
        Name = ot.Tax.Name,
        TaxFlat = ot.TaxFlat,
        TaxPercentage = ot.TaxPercentage
    })));
    window.sgstSettings = {
        percentage: @sgstPercentage,
        isChecked: @Json.Serialize(isSgstChecked)
    };
    window.taxSettings = @Html.Raw(JsonConvert.SerializeObject(flatTaxStates));

    let isSaving = false;
    let isCompleting = false;
    let isCanceling = false;
    let isGeneratingInvoice = false;
    let reviewRatings = {
        food: 0,
        service: 0,
        ambience: 0
    };
    let currentOrderItemId = null;

    function updateCartDisplay() {
        const $accordion = $('#cartAccordion');
        const $cartSummary = $('#cartSummary');
        $accordion.empty();
        $cartSummary.empty();

        let subtotal = 0;

        window.cartItems.forEach(item => {
            const modifiersTotal = item.Modifiers.reduce((sum, mod) => sum + mod.Price, 0) * item.Quantity;
            const itemBaseTotal = item.ItemPrice * item.Quantity;
            subtotal += itemBaseTotal + modifiersTotal;

            const accordionHtml = `
                <div class="accordion mt-1" id="itemAccordian-${item.Id}-${item.GlobalId}">
                    <div class="accordion-item d-flex justify-content-between text-secondary mb-2 mt-1">
                        <div class="d-flex flex-column">
                            <div class="accordion-header text-secondary d-flex fw-bolder align-items-center">
                                <div class="d-flex align-items-center">
                                    <button class="accordion-button pe-1 ps-2 text-secondary fw-bolder rounded-2 collapsed"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapse-${item.Id}-${item.GlobalId}"
                                            aria-controls="collapse-${item.Id}-${item.GlobalId}">
                                    </button>
                                    <div class="item-name-order-card" data-order-item-id="${item.OrderItemId}" data-globalId="${item.GlobalId}"  >
                                        <div class="text-truncate" style="max-width:150px;">${item.Name}</div>
                                    </div>
                                </div>
                            </div>
                            <div id="collapse-${item.Id}-${item.GlobalId}" class="accordion-collapse collapse"
                                data-bs-parent="#itemAccordian-${item.Id}-${item.GlobalId}">
                                <div class="accordion-body">
                                    ${item.Modifiers.map(mod => `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>${mod.Name}</span>
                                            <span>₹${mod.Price.toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-4 me-3 align-items-center">
                            <div class="d-flex align-items-center gap-2 border border-secondary rounded px-2 py-1 quantity-selector text-secondary justify-content-between"
                                style="width:100px">
                                <button class="btn btn-sm border-0 bg-transparent minus px-2 py-1"
                                    data-globalId="${item.GlobalId}">-</button>
                                <div class="count">${item.Quantity}</div>
                                <button class="btn btn-sm border-0 bg-transparent plus px-2 py-1"
                                    data-globalId="${item.GlobalId}">+</button>
                            </div>
                            <div style="width:100px;">
                                <span class="fs-5">₹${itemBaseTotal.toFixed(2)}</span><br>
                                <span>₹${modifiersTotal.toFixed(2)}</span>
                            </div>
                            <a class="btn border-0 p-0 delete-item" data-globalId="${item.GlobalId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    class="bi bi-trash3" viewBox="0 0 16 16">
                                    <path
                                        d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 0 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            $accordion.append(accordionHtml);
        });

        let totalTaxes = 0;
        const taxHtml = [];
        if (window.orderTaxes) {
            window.orderTaxes.forEach(tax => {
                let taxAmount = 0;
                if (tax.TaxFlat !== null && window.taxSettings[tax.Name]) {
                    taxAmount = parseFloat(tax.TaxFlat) || 0;
                    taxHtml.push(`
                        <div class="d-flex justify-content-between tax-row" data-tax-name="${tax.Name}">
                            <span>
                                <input type="checkbox" class="checkbox flat-tax-checkbox form-check-input" data-tax-name="${tax.Name}" checked>
                                ${tax.Name} (₹${taxAmount.toFixed(2)})
                            </span>
                            <span style="display: block;">
                                ₹${taxAmount.toFixed(2)}
                            </span>
                        </div>
                    `);
                } else if (tax.TaxFlat !== null) {
                    taxHtml.push(`
                        <div class="d-flex justify-content-between tax-row" data-tax-name="${tax.Name}" style="display: none;">
                            <span>
                                <input type="checkbox" class="checkbox flat-tax-checkbox form-check-input" data-tax-name="${tax.Name}">
                                ${tax.Name} (₹${(parseFloat(tax.TaxFlat) || 0).toFixed(2)})
                            </span>
                            <span style="display: none;">
                                ₹${(parseFloat(tax.TaxFlat) || 0).toFixed(2)}
                            </span>
                        </div>
                    `);
                } else if (tax.TaxPercentage !== null) {
                    taxAmount = subtotal * (tax.TaxPercentage / 100);
                    taxHtml.push(`
                        <div class="d-flex justify-content-between tax-row" data-tax-name="${tax.Name}">
                            <span>${tax.Name} (${tax.TaxPercentage}%)</span>
                            <span>₹${taxAmount.toFixed(2)}</span>
                        </div>
                    `);
                }
                totalTaxes += taxAmount;
            });
        }

        const sgstAmount = window.sgstSettings.isChecked ? subtotal * (window.sgstSettings.percentage / 100) : 0;
        totalTaxes += sgstAmount;

        // Update cart summary
        $cartSummary.append(`
            <div class="d-flex justify-content-between">
                <span>SUBTOTAL</span>
                <span>₹${subtotal.toFixed(2)}</span>
            </div>
            ${taxHtml.join('')}
            <div class="d-flex justify-content-between fw-bold">
                <span>TOTAL</span>
                <span>₹${(subtotal + totalTaxes).toFixed(2)}</span>
            </div>
        `);
    }

    function loadCart(orderId) {
        $.ajax({
            url: '@Url.Action("GetOrderDetails", "OrderApp")',
            type: 'GET',
            data: { orderId: orderId },
            dataType: 'json',
            success: function (result) {
                if (result && typeof result === 'object' && result.success) {
                    window.cartItems = result.orderItems.map(oi => ({
                        Id: oi.itemId,
                        OrderItemId: oi.id,
                        Name: oi.itemName,
                        Quantity: oi.quantity,
                        ItemPrice: oi.unitPrice,
                        TotalPrice: oi.totalPrice,
                        ReadyQuantity: oi.readyQuantity,
                        SpecialInstructions: oi.specialInstructions,
                        Modifiers: oi.modifiers.map(oim => ({
                            Id: oim.modifierId,
                            Name: oim.modifierName,
                            Price: oim.price
                        })),
                        GlobalId: oi.itemName.toLowerCase().replace(/\s+/g, '') + '-' + oi.id
                    }));
                    window.orderTaxes = result.orderTaxes.map(ot => ({
                        Name: ot.taxName,
                        TaxFlat: ot.taxFlat,
                        TaxPercentage: ot.taxPercentage
                    }));
                    window.taxSettings = result.orderTaxes.reduce((acc, ot) => {
                        acc[ot.taxName] = ot.isApplied;
                        return acc;
                    }, {});
                    updateCartDisplay();
                } else {
                    toastr.error(result && result.message ? result.message : 'Failed to load cart data.');
                }
            },
            error: function () {
                toastr.error('Failed to load cart. Please try again.');
            }
        });
    }

    $(document).ready(function () {
        updateCartDisplay();

        // Star rating functionality
        $('.star-rating .star').on('click', function () {
            const ratingType = $(this).parent().data('rating-type');
            const value = parseInt($(this).data('value'));
            reviewRatings[ratingType] = value;

            $(this).parent().find('.star').each(function () {
                const starValue = parseInt($(this).data('value'));
                if (starValue <= value) {
                    $(this).addClass('filled');
                } else {
                    $(this).removeClass('filled');
                }
            });
        });

        // Open Special Instructions Modal when clicking on item name
        $('#cartAccordion').on('click', '.item-name-order-card', function () {
            const orderItemId = $(this).data('order-item-id');
            const globalId = $(this).data('globalid');
            const item = window.cartItems.find(ci => ci.GlobalId === globalId);
            if (item) {
                currentOrderItemId = orderItemId;
                $('#itemName').text(item.Name);
                $('#specialInstructionsInput').val(item.SpecialInstructions || '');
                $('#specialInstructionsModal').modal('show');
            }
        });

        // Save Special Instructions
        $('#saveSpecialInstructionsButton').on('click', function () {
            const specialInstructions = $('#specialInstructionsInput').val();
            if (!currentOrderItemId) {
                toastr.error('Order item ID is missing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("SaveSpecialInstructions", "OrderApp")',
                type: 'POST',
                data: {
                    orderItemId: currentOrderItemId,
                    specialInstructions: specialInstructions
                },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        const item = window.cartItems.find(ci => ci.OrderItemId === currentOrderItemId);
                        if (item) {
                            item.SpecialInstructions = specialInstructions;
                            updateCartDisplay();
                        }
                        toastr.success(result.message || 'Special instructions saved successfully.');
                        $('#specialInstructionsModal').modal('hide');
                    } else {
                        toastr.error(result.message || 'Failed to save special instructions.');
                    }
                },
                error: function () {
                    toastr.error('Failed to save special instructions. Please try again.');
                }
            });
        });

        // Open Order-Wise Comment Modal
        $('#orderCommentButton').on('click', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            if (!orderId) {
                toastr.error('Order ID is missing.');
                return;
            }

            // Fetch the current OrderInstructions
            $.ajax({
                url: '@Url.Action("GetOrderById", "OrderApp")',
                type: 'GET',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result && result.success) {
                        $('#orderWiseCommentInput').val(result.OrderInstructions || '');
                        $('#orderWiseCommentModal').modal('show');
                    } else {
                        toastr.error(result.message || 'Failed to load order details.');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to load order details. Please try again.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.message) {
                            errorMessage = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMessage);
                }
            });
        });

        // Save Order-Wise Comment
        $('#saveOrderWiseCommentButton').on('click', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const comment = $('#orderWiseCommentInput').val();

            if (!orderId) {
                toastr.error('Order ID is missing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("SaveOrderInstructions", "OrderApp")',
                type: 'POST',
                data: {
                    orderId: orderId,
                    orderInstructions: comment
                },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        toastr.success(result.message || 'Order comment saved successfully.');
                        $('#orderWiseCommentModal').modal('hide');
                    } else {
                        toastr.error(result.message || 'Failed to save order comment.');
                    }
                },
                error: function () {
                    toastr.error('Failed to save order comment. Please try again.');
                }
            });
        });

        // Handle Generate Invoice Button Click
        $('#generateInvoiceButton').on('click', function (e) {
            e.preventDefault();

            if (isGeneratingInvoice) {
                return;
            }
            isGeneratingInvoice = true;

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                isGeneratingInvoice = false;
                return;
            }

            // Check if all items are ready
            $.ajax({
                url: '@Url.Action("CheckOrderItemsReady", "OrderApp")',
                type: 'GET',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        if (result.areAllItemsReady) {
                            // All items are ready, proceed with invoice generation
                            $.ajax({
                                url: '/Orders/Invoice',
                                type: 'GET',
                                data: { orderId: orderId },
                                success: function (response) {
                                    var tempDiv = $("<div>").css({
                                        "position": "absolute",
                                        "left": "-9999px",
                                        "top": "-9999px",
                                        "width": "1000px",
                                        "height": "auto",
                                        "background": "white",
                                        "z-index": "-1"
                                    }).html(response).appendTo("body");

                                    setTimeout(function () {
                                        html2canvas(tempDiv[0], { scale: 2, useCORS: true }).then(function (canvas) {
                                            var imgData = canvas.toDataURL("image/png");
                                            var { jsPDF } = window.jspdf;
                                            var pdf = new jsPDF("p", "mm", "a4");
                                            var imgWidth = 210;
                                            var imgHeight = (canvas.height * imgWidth) / canvas.width;
                                            pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
                                            pdf.save("invoice_" + orderId + ".pdf");
                                            tempDiv.remove();
                                        }).catch(function (error) {
                                            console.error("Error rendering canvas:", error);
                                            toastr.error("Error generating PDF. Please try again.");
                                            tempDiv.remove();
                                        });
                                    }, 10);
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error fetching invoice:", error);
                                    toastr.error("Error fetching invoice. Please try again.");
                                },
                                complete: function () {
                                    isGeneratingInvoice = false;
                                }
                            });
                        } else {
                            toastr.error('You cannot generate invoice because some items are still in Progress.');
                            isGeneratingInvoice = false;
                        }
                    } else {
                        toastr.error(result.message || 'Failed to check order items status.');
                        isGeneratingInvoice = false;
                    }
                },
                error: function () {
                    toastr.error('Failed to check order items status. Please try again.');
                    isGeneratingInvoice = false;
                }
            });
        });

        $('#cartAccordion').on('click', '.quantity-selector .plus', function () {
            const globalId = $(this).data('globalid');
            const item = window.cartItems.find(ci => ci.GlobalId === globalId);
            if (item) {
                item.Quantity += 1;
                item.TotalPrice = item.ItemPrice * item.Quantity;
                updateCartDisplay();
            }
        });

        $('#cartAccordion').on('click', '.quantity-selector .minus', function () {
            const globalId = $(this).data('globalid');
            const item = window.cartItems.find(ci => ci.GlobalId === globalId);
            if (item) {
                // Check if decreasing quantity would go below ReadyQuantity
                if (item.Quantity - 1 < item.ReadyQuantity) {
                    toastr.error(`You cannot decrease this item's quantity because ${item.ReadyQuantity} item(s) are already prepared.`);
                    return;
                }
                // Only allow decreasing if Quantity is greater than 1 and won't go below ReadyQuantity
                if (item.Quantity > 1) {
                    item.Quantity -= 1;
                    item.TotalPrice = item.ItemPrice * item.Quantity;
                    updateCartDisplay();
                }
            }
        });

        $('#cartAccordion').on('click', '.delete-item', function () {
            const globalId = $(this).data('globalid');
            const item = window.cartItems.find(ci => ci.GlobalId === globalId);
            if (item) {
                if (item.ReadyQuantity > 0) {
                    toastr.error(`You cannot delete this item because ${item.ReadyQuantity} item(s) are already prepared.`);
                    return;
                }
                window.cartItems = window.cartItems.filter(ci => ci.GlobalId !== globalId);
                updateCartDisplay();
            }
        });

        $('#cartSummary').on('change', '.flat-tax-checkbox', function () {
            const taxName = $(this).data('tax-name');
            const isChecked = $(this).is(':checked');
            window.taxSettings[taxName] = isChecked;
            const $taxRow = $(this).closest('.tax-row');

            $taxRow.css('display', isChecked ? '' : 'none');
            $taxRow.find('span:last').css('display', isChecked ? 'block' : 'none');

            const subtotal = parseFloat($('.d-flex.justify-content-between:contains("SUBTOTAL") span:last').text().replace('₹', '')) || 0;
            let totalTaxes = 0;

            window.orderTaxes.forEach(tax => {
                if (tax.TaxFlat !== null && window.taxSettings[tax.Name]) {
                    totalTaxes += parseFloat(tax.TaxFlat) || 0;
                } else if (tax.TaxPercentage !== null) {
                    totalTaxes += subtotal * (tax.TaxPercentage / 100);
                }
            });

            const sgstAmount = window.sgstSettings.isChecked ? subtotal * (window.sgstSettings.percentage / 100) : 0;
            totalTaxes += sgstAmount;

            const total = subtotal + totalTaxes;
            $('.d-flex.justify-content-between.fw-bold span:last').text(`₹${total.toFixed(2)}`);
        });

        $('#cartSummary').on('change', '.sgst-checkbox', function () {
            const isChecked = $(this).is(':checked');
            window.sgstSettings.isChecked = isChecked;
            const subtotal = parseFloat($('.d-flex.justify-content-between:contains("SUBTOTAL") span:last').text().replace('₹', '')) || 0;
            const sgstAmount = isChecked ? subtotal * (@sgstPercentage / 100) : 0;

            $(this).closest('.d-flex').find('span:last').text(`₹${sgstAmount.toFixed(2)}`);

            let totalTaxes = 0;
            window.orderTaxes.forEach(tax => {
                if (tax.TaxFlat !== null && window.taxSettings[tax.Name]) {
                    totalTaxes += parseFloat(tax.TaxFlat) || 0;
                } else if (tax.TaxPercentage !== null) {
                    totalTaxes += subtotal * (tax.TaxPercentage / 100);
                }
            });
            totalTaxes += sgstAmount;
            const total = subtotal + totalTaxes;

            $('.d-flex.justify-content-between.fw-bold span:last').text(`₹${total.toFixed(2)}`);
        });

        $('#completeOrderButton').off('click').on('click', function (e) {
            e.preventDefault();

            if (isCompleting) {
                return;
            }
            isCompleting = true;

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                isCompleting = false;
                return;
            }

            $.ajax({
                url: '@Url.Action("CheckOrderItemsReady", "OrderApp")',
                type: 'GET',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        if (result.areAllItemsReady) {
                            $('#completeConfirmationModal').modal('show');
                        } else {
                            toastr.error('You cannot complete this order because some items are still in progress.');
                        }
                    } else {
                        toastr.error(result.message || 'Failed to check order items status.');
                    }
                },
                error: function () {
                    toastr.error('Failed to check order items status. Please try again.');
                },
                complete: function () {
                    isCompleting = false;
                }
            });
        });

        $('#confirmCompleteButton').off('click').on('click', function () {
            $('#completeConfirmationModal').modal('hide');

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("CompleteOrder", "OrderApp")',
                type: 'POST',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        toastr.success(result.message || 'Order completed successfully.');
                        if (result.showReviewModal) {
                            $('#customerReviewModal').modal('show');
                        } else {
                            window.location.href = '@Url.Action("Table", "OrderApp")';
                        }
                    } else {
                        toastr.error(result.message || 'Failed to complete order.');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to complete order. Please try again.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.message) {
                            errorMessage = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMessage);
                }
            });
        });

        $('#cancelOrderButton').off('click').on('click', function (e) {
            e.preventDefault();

            if (isCanceling) {
                return;
            }
            isCanceling = true;

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                isCanceling = false;
                return;
            }

            // Check if all items are in_progress
            $.ajax({
                url: '@Url.Action("CheckOrderItemsInProgress", "OrderApp")',
                type: 'GET',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        if (result.areAllItemsInProgress) {
                            $('#cancelConfirmationModal').modal('show');
                        } else {
                            toastr.error('You cannot cancel this order because some items are already prepared.');
                        }
                    } else {
                        toastr.error(result.message || 'Failed to check order items status.');
                    }
                },
                error: function () {
                    toastr.error('Failed to check order items status. Please try again.');
                },
                complete: function () {
                    isCanceling = false;
                }
            });
        });

        $('#confirmCancelButton').off('click').on('click', function () {
            $('#cancelConfirmationModal').modal('hide');

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("CancelOrder", "OrderApp")',
                type: 'POST',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        toastr.success(result.message || 'Order canceled successfully.');
                        window.location.href = '@Url.Action("Table", "OrderApp")';
                    } else {
                        toastr.error(result.message || 'Failed to cancel order.');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to cancel order. Please try again.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.message) {
                            errorMessage = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMessage);
                }
            });
        });

        $('#submitReviewButton').on('click', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const comment = $('#reviewComment').val();

            const reviewData = {
                orderId: orderId,
                foodRating: reviewRatings.food,
                serviceRating: reviewRatings.service,
                ambienceRating: reviewRatings.ambience,
                comment: comment
            };

            $.ajax({
                url: '@Url.Action("SubmitCustomerReview", "OrderApp")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(reviewData),
                dataType: 'json',
                success: function (result) {
                    if (result.success) {
                        toastr.success(result.message || 'Thank you for your feedback!');
                        $('#customerReviewModal').modal('hide');
                        window.location.href = '@Url.Action("Table", "OrderApp")';
                    } else {
                        toastr.error(result.message || 'Failed to submit review.');
                    }
                },
                error: function () {
                    toastr.error('Failed to submit review. Please try again.');
                }
            });
        });

        $('#customerReviewModal').on('hidden.bs.modal', function () {
            window.location.href = '@Url.Action("Table", "OrderApp")';
        });

        $('#saveOrderButton').off('click').on('click', function (e) {
            e.preventDefault();

            if (isSaving) {
                return;
            }
            isSaving = true;

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                toastr.error('Order ID is missing.');
                isSaving = false;
                return;
            }

            const paymentMethod = $('input[name="paymentMethod"]:checked').attr('id');
            const cartItems = window.cartItems.map(item => ({
                ItemId: item.Id,
                Quantity: item.Quantity,
                UnitPrice: item.ItemPrice,
                TotalPrice: item.ItemPrice * item.Quantity,
                Modifiers: item.Modifiers.map(mod => ({
                    ModifierId: mod.Id,
                    Quantity: item.Quantity,
                    Price: mod.Price
                }))
            }));

            const taxSettings = {};
            window.orderTaxes.forEach(tax => {
                taxSettings[tax.Name] = window.taxSettings[tax.Name] || false;
            });

            const orderData = {
                OrderId: orderId,
                TotalAmount: parseFloat($('.d-flex.justify-content-between.fw-bold span:last').text().replace('₹', '')),
                PaymentMethod: paymentMethod,
                CartItems: cartItems,
                TaxSettings: taxSettings
            };

            $.ajax({
                url: '@Url.Action("SaveOrder", "OrderApp")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                dataType: 'json',
                success: function (result) {
                    if (result && typeof result === 'object' && result.hasOwnProperty('success')) {
                        if (result.success) {
                            toastr.success(result.message || 'Order saved successfully.');
                            loadCart(orderId);
                        } else {
                            toastr.error(result.message || 'Failed to save order.');
                        }
                    } else {
                        toastr.error('Unexpected response from server. Please try again.');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to save order. Please try again.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.message) {
                            errorMessage = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMessage);
                },
                complete: function () {
                    isSaving = false;
                }
            });
        });
    });
</script>