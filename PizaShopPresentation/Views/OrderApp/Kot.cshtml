@{
    ViewData["Title"] = "Kitchen Order Tickets";
    Layout = "~/Views/Shared/_LayoutOrdApp.cshtml";
}
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="Users-content mt-0 p-xl-5 p-lg-4 p-md-4 p-sm-4 p-4">
    <div class="d-flex align-items-center justify-content-start my-2">
        <div>
            <div class="fw-bolder fs-2 page-text">Kitchen Order Tokens</div>
        </div>
    </div>

    <div class="row mb-3 upper-div rounded-2 shadow py-3 d-flex">
        <ul class="nav nav-underline" id="categoryTabs">
            <li class="nav-item">
                <a class="nav-link custom-tag mx-3 active" data-category="All" role="tab">
                    All
                </a>
            </li>
            @foreach (var category in ViewBag.Categories)
            {
                <li class="nav-item">
                    <a class="nav-link custom-tag mx-3 text-decoration-none text-black" data-category="@category.Name"
                        role="tab">
                        @category.Name
                    </a>
                </li>
            }
        </ul>
    </div>

    <div class="row content-div rounded-2 shadow">
        <div class="tab-content w-100">
            <div class="row">
                <div class="col-md-12 mb-3 d-flex justify-content-end">
                    <button id="in-progress-btn" class="btn status-btn me-2 active">In Progress</button>
                    <button id="ready-btn" class="btn status-btn me-2">Ready</button>
                    <button class="btn btn-main text-white me-2">
                        < </button>
                            <button class="btn btn-main text-white"> > </button>
                </div>
                <div class="col-md-12">
                    <div id="kot-in-progress" class="row"></div>
                </div>
                <div class="col-md-12">
                    <div id="kot-ready" class="row"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSlide = 0;
    const cardsToShow = 1; // or 2, depending on screen
    const cardWidth = 370; // match your kot-card width + margin

    function nextslide() {
        const cardWrapper = document.getElementById('cardWrapper');
        const totalCards = cardWrapper?.children.length ?? 0;
        const maxSlide = totalCards - cardsToShow;

        if (currentSlide < maxSlide) {
            currentSlide += cardsToShow;
            const offset = -currentSlide * cardWidth;
            cardWrapper.style.transform = `translateX(${offset}px)`;
        }
    }

    function backslide() {
        const cardWrapper = document.getElementById('cardWrapper');

        if (currentSlide > 0) {
            currentSlide -= cardsToShow;
            const offset = -currentSlide * cardWidth;
            cardWrapper.style.transform = `translateX(${offset}px)`;
        }
    }

    document.querySelectorAll('.btn-main').forEach(btn => {
        btn.addEventListener('click', function () {
            if (this.textContent.trim() === ">") nextslide();
            if (this.textContent.trim() === "<") backslide();
        });
    });

    function loadKotData(category, status) {
        $.ajax({
            url: `/OrderApp/GetKotByCategoryAndStatus`,
            data: { category: category, status: status },
            success: function (data) {
                // Clear both sections and populate only the requested status
                $('#kot-in-progress').html(status === 'in_progress' ? data : '');
                $('#kot-ready').html(status === 'ready' ? data : '');
            }
        });
    }

    function updateTimeSinceOrder() {
        document.querySelectorAll(".time-since-order").forEach(function (element) {
            const createdAt = element.dataset.createdat;
            if (!createdAt) {
                element.innerText = "N/A";
                return;
            }

            const createdDate = new Date(createdAt);
            const now = new Date();
            let diff = Math.floor((now - createdDate) / 1000); // difference in seconds

            const days = Math.floor(diff / (60 * 60 * 24));
            diff %= (60 * 60 * 24);
            const hours = Math.floor(diff / (60 * 60));
            diff %= (60 * 60);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;

            let parts = [];
            if (days > 0) parts.push(`${days} day${days !== 1 ? 's' : ''}`);
            if (hours > 0 || days > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);
            if (minutes > 0 || hours > 0 || days > 0) parts.push(`${minutes} min${minutes !== 1 ? 's' : ''}`);
            parts.push(`${seconds} sec${seconds !== 1 ? 's' : ''}`);

            element.innerText = parts.join(" ");
        });
    }

    // Update every second
    setInterval(updateTimeSinceOrder, 1000);
    // Initial call
    updateTimeSinceOrder();

    $(document).ready(function () {
        let selectedCategory = "All";
        let selectedStatus = 'in_progress'; // Default to in_progress

        // Initial load with all categories and in_progress status
        loadKotData(selectedCategory, selectedStatus);
        $('#in-progress-btn').addClass('active'); // Set In Progress button as active by default

        // Handle category tab clicks
        $('#categoryTabs .nav-link').on('click', function () {
            $('#categoryTabs .nav-link').removeClass('active');
            $(this).addClass('active');
            selectedCategory = $(this).data('category');
            loadKotData(selectedCategory, selectedStatus);
        });

        // Handle status button clicks
        $('#in-progress-btn').on('click', function () {
            selectedStatus = 'in_progress';
            loadKotData(selectedCategory, selectedStatus);
            $('#in-progress-btn').addClass('active').removeClass('inactive');
            $('#ready-btn').removeClass('active').addClass('inactive');
        });

        $('#ready-btn').on('click', function () {
            selectedStatus = 'ready';
            loadKotData(selectedCategory, selectedStatus);
            $('#ready-btn').addClass('active').removeClass('inactive');
            $('#in-progress-btn').removeClass('active').addClass('inactive');
        });
    });
</script>

<style>
    .nav-underline .nav-link {
        color: #1f73ae;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        cursor: pointer;
    }

    .nav-underline .nav-link.active {
        font-size: 1.1rem;
        color: #1f73ae;
        border-bottom: 2px solid #1f73ae;
    }

    .custom-tag {
        display: flex;
        align-items: center;
    }

    .upper-div {
        background: #fff;
    }

    .content-div {
        background: #fff;
        padding: 1rem;
    }

    .kot-card {
        background: #fff;
        border: 3px dashed #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-main {
        background-color: #1f73ae;
        border: none;
        color: white;
    }

    .btn-main:hover {
        background-color: #175a8a;
    }

    .page-text {
        color: #1f73ae;
    }

    p {
        margin-top: 0;
        margin-bottom: 0.1rem;
    }

    .card-slider.transition {
        transition: transform 0.5s ease;
    }

    /* Status button styles */
    .status-btn {
        border: 1px solid #1f73ae;
        transition: background-color 0.3s, color 0.3s;
    }

    .status-btn.active {
        background-color: #1f73ae;
        color: white;
    }

    .status-btn.inactive {
        background-color: white;
        color: #1f73ae;
    }
</style>